---
title: "Small Business Loan Exploratory Data Analysis"
author: "Heather Qiu, Aditya John, Isha Singh, Jenny Shen"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE,warning = FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(ISLR2)
library(kableExtra)
library(stargazer)
library(ggplot2)
library(caret)
library(dplyr)
library(leaps)
library(tidyverse)
library(table1)
library(Hmisc)
library(lubridate)
```

# __Data Overview__
The original dataset is from U.S. Small Business Administration (SBA), a governmental agency founded in 1953 to provide financial assistance to small enterprises in the U.S. credit market. The file contains 899,164 loan records from small businesses across the country and 27 variables. A detailed description of all variables can be found in Table 1. For the project, our primary research interests can be summarized into the following questions:

1. How does the requested loan duration (***Term***), revolving line of credit (***RevLineCr***), and employee count (***NoEmp***) of a small business impact the amount of the approved SBA loan (***GrAppv***)?
2. What are the different factors that impact the defaulting of a loan?

In addition, there are complexities in the original dataset to be aware of:

* Missing Values. Due to the large dataset, it is not uncommon to find missing values on some variables. Table 2 shows the count of missing values for all variables in the original file. For the scope of the current project, we will exclude loan records with missing values except for the variable, ***ChgOffDate***, which indicates a date when a loan is declared to be in default. Given the rigorous review procedure that banks have set in place, only a small portion of loans are expected to default. Therefore, loans in good standing or have been paid off won't indicate a date when the loan is declared to be in default (***ChgOffDate***).

* Inconsistent Data Format. The following categorical variables contain values other than yes and no. Without further clarification from the original dataset, we will exclude loan records beyond the binary choices. 
  + Revolving Line of Credit (***RevLineCr***)
  + Business Status: New or Existing Businesses (***NewExist***)
  + Business Locale: Rural or Urban (***UrbanRural***)
  + LowDoc Loan Program (***LowDoc***)

* Incorrect Data Type. The following variables that contain monetary values are represented as strings rather than numeric numbers in the original file. These variables will be converted to the numeric data type for our analysis. 
  + SBA’s Guaranteed Amount of Approved Loan (***SBA_Appv***)
  + Gross Amount of Loan Approved by Bank (***GrAppv***)
  + Charged-off Amount (***ChgOffPrinGr***)
  + Gross Amount Outstanding (***BalanceGross***)
  + Amount Disbursed (***DisbursementGross***)
  

# __Primary Relationship of Interest__ 
Tables 4 through 7 in the Appendix present the descriptive statistics for our second research question. The key findings include:

* Majority of the establishments applying for the small business loans are existing businesses that operate in urban settings. 
* California, New York, and Florida have the highest percentage of small businesses defaulting on their loans. 
* 77% of small business loans in default occurred between the time period of 2005 and 2008, but this is likely due to the fact that about 76% of loans were distributed around the same time period. 

```{r pri, echo = FALSE, results = "asis", message = FALSE, warning = FALSE, fig.width=5,fig.height=4,fig.align='center'}
##Read into the original dataset
sbl <- read.csv("SBAnational.csv", header=T, na.strings=c(""," ","NA"))

##Remove blank row or rows of binary variables that contain values other than yes and no
sbl$NewExist[sbl$NewExist == 0] <- NA
sbl$UrbanRural[sbl$UrbanRural == 0] <- NA
sbl <- sbl[!is.na(sbl$RevLineCr) == TRUE ,]
sbl <- sbl[!is.na(sbl$NewExist) == TRUE ,]
sbl <- sbl[!is.na(sbl$UrbanRural) == TRUE ,]
sbl <- sbl[!is.na(sbl$Name) == TRUE ,]
sbl <- sbl[!is.na(sbl$City) == TRUE ,]
sbl <- sbl[!is.na(sbl$State) == TRUE ,]
sbl <- sbl[!is.na(sbl$Bank) == TRUE ,]
sbl <- sbl[!is.na(sbl$BankState) == TRUE ,]
sbl <- sbl[!is.na(sbl$LowDoc) == TRUE ,]
sbl <- sbl[!is.na(sbl$DisbursementDate) == TRUE ,]
sbl <- sbl[!is.na(sbl$DisbursementGross) == TRUE ,]
sbl <- sbl[!is.na(sbl$MIS_Status) == TRUE ,]
sbl <- subset(sbl, RevLineCr =="Y" | RevLineCr =="N")
sbl <- subset(sbl, LowDoc =="Y" | LowDoc =="N")

##Remove '$' sign and commas then convert to double in the money columns and store the values in new columns
sbl$SBA_Appv_num <-str_replace_all(sbl$SBA_Appv,"[\\$,]","")%>% as.double()
sbl$GrAppv_num <-str_replace_all(sbl$GrAppv,"[\\$,]","") %>% as.double()
sbl$ChgOffPrinGr_num <-str_replace_all(sbl$ChgOffPrinGr,"[\\$,]","") %>% as.double()
sbl$BalanceGross_num <-str_replace_all(sbl$BalanceGross,"[\\$,]","") %>% as.double()
sbl$DisbursementGross_num <-str_replace_all(sbl$DisbursementGross,"[\\$,]","") %>% as.double()

## Extract the year of disbursement from Disbursement Date
sbl$Disbursement_Year <- year(as.Date(sbl$DisbursementDate,"%d-%b-%y"))

##Factor Categorical Variables listed as numeric
sbl$NewExist_fac <- factor(sbl$NewExist, levels = c("1","2"), 
                        labels = c("Existing Business","New Business"))

sbl$UrbanRural_fac <- factor(sbl$UrbanRural, levels = c("1","2"), 
                        labels = c("Urban","Rural"))
```



# __Other Characteristics__


# __Potential Challenges__


\pagebreak

# __Appendix__

```{r appendix, echo = FALSE, results = "asis", message = FALSE, warning = FALSE, fig.width=5,fig.height=4,fig.align='center'}

#Code Book
data_dict <- matrix(
  c("LoanNr_ChkDgt","Name","City","State",
    "Zip", "Bank", "BankState","NAICS", "ApprovalDate",
    "ApprovalFY","Term","NoEmp","NewExist","CreateJob",
    "RetainedJob","FranchiseCode","UrbanRural","RevLineCr",
    "LowDoc","ChgOffDate","DisbursementDate","DisbursementGross",
    "BalanceGross","MIS_Status","ChgOffPrinGr","GrAppv","SBA_Appv",
    "Identifier Primary Key","Borrower Name","Borrower City",
    "Borrower State","Borrower Zip Code","Bank Name",
    "Bank State","North American Industry Classification System Code",
    "Date SBA Commitment Issued","Fiscal Year of Commitment",
    "Loan Term in Months","Number of Business Employees",
    "1 = Existing Business, 2 = New Business, 0 = Undefined","Number of Jobs Created",
    "Number of Jobs Retained","Franchise Code, (00000 or 00001) = No Franchise",
    "1 = Urban, 2 = Rural, 0 = Undefined",
    "Revolving Line of Credit: Y = Yes, N = No",
    "LowDoc Loan Program: Y = Yes, N = No",
    "The date when a loan is declared to be in default",
    "Disbursement Date","Amount Disbursed","Gross Amount Outstanding",
    "Loan Status Charged off = CHGOFF, Paid in Full =PIF",
    "Charged-off Amount","Gross Amount of Loan Approved by Bank",
    "SBA’s Guaranteed Amount of Approved Loan"),nrow=27,ncol=2)

kable(data_dict,
      col.names=c("Variable","Description"),
      format="latex",
      booktabs=T,
      caption="Code Book") %>% 
  kable_styling(position="center",latex_options = c("hold_position"))

#Missing Value Overview
MissingValues <- matrix(
  c("LoanNr_ChkDgt","Name","City","State",
    "Zip", "Bank", "BankState","NAICS", "ApprovalDate",
    "ApprovalFY","Term","NoEmp","NewExist","CreateJob",
    "RetainedJob","FranchiseCode","UrbanRural","RevLineCr",
    "LowDoc","ChgOffDate","DisbursementDate","DisbursementGross",
    "BalanceGross","MIS_Status","ChgOffPrinGr","GrAppv","SBA_Appv",
    "0","8","30","14","0","1559","1566","0","0","0","0","0","136",
    "0","0","0","0","4528","2582","736465","2368","0","0","1997",
    "0","0","0"),
  nrow=27,ncol=2)

kable(MissingValues,
      col.names=c("Variable","Count of Missing Values"),
      format="latex",
      booktabs=T,
      caption="Missing Value Overview") %>% 
  kable_styling(position="center",latex_options = c("hold_position"))


##EDA for Research Question #2
cat("\n\n\\pagebreak\n")
cat(text="Table 4.Descriptive of Small Business Loans by Loan Status (I)")
table1(~Term+NoEmp+NewExist_fac+CreateJob+
    RetainedJob+UrbanRural_fac+RevLineCr+LowDoc
    +SBA_Appv_num+GrAppv_num+ChgOffPrinGr_num+BalanceGross_num
    +DisbursementGross_num|MIS_Status,
       data=sbl)

cat("\n\n\\pagebreak\n")
cat(text="Table 5.Descriptive of Small Business Loans by Loan Status (II)")
table1(~State|MIS_Status,data=sbl)

cat("\n\n\\pagebreak\n")
cat(text="Table 6.Descriptive of Small Business Loans by Loan Status (III)")
table1(~ApprovalFY|MIS_Status,data=sbl)

cat("\n\n\\pagebreak\n")
cat(text="Table 7.Descriptive of Small Business Loans by Loan Status (IV)")
table1(~factor(Disbursement_Year)|MIS_Status,data=sbl)
```
